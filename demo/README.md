# CRD API Demo: Employee Roster

This is a simple example of a CRD based application, with which a client
interacts by manipulating custom resources.

This application tracks employees in a company and  aggregates their information
in rosters (ConfigMaps). Employees in a given namespace are all aggregated into one
ConfigMap, whose name is derived from the Employee objects' namespaces. All such
rosters are created in the default namespace. Users can add and remove employees,
and edit their information, by manipulating the corresponding `Employee` object.
The CR controller is responsible for reconciling changes to `Employee`s with the
associated roster.

The CRD and controller skeleton code are generated by
[KubeBuilder](https://kubebuilder.io), a CRD API development framework. You can
recreate this project from scratch by following this document.

In summary, to get the cluster going from scratch:
```console
demo/$ make manifests
demo/$ make install
demo/$ docker login -u <user>
demo/$ make docker-build docker-push deploy IMG=<user>/<repo>[:<tag>]
```

# Setup

To recreate this directory from scratch and deploy the CRD and controller:

1. In a new directory `demo/`, initialize a new Go project
   ```console
   $ mkdir demo && cd demo
   demo/$ go mod init github.com/adowair/cnr-na22
   go: creating new go.mod: module github.com/adowair/cnr-na22
   ```
3. If you haven't already, install KubeBuilder using your favorite package
   manager
   ```console
   demo/$ brew install kubebuilder
   ```
4. Initialize a KubeBuilder project
   ```console
   demo/$ kubebuilder init
   Writing kustomize manifests for you to edit...
   Writing scaffold for you to edit...
   Get controller runtime:
     $ go get sigs.k8s.io/controller-runtime@v0.13.0
   Update dependencies:
     $ go mod tidy
   Next: define a resource with:
     $ kubebuilder create api
   ```
5. Create a new API kind `Employee`, specifying its group and version.
   You will be prompted to create the resource and its controller-agree
   to both
   ```console
   demo/$ kubebuilder create api --group cnr-na22 --version v1 --kind Employee
   Create Resource [y/n]
   y
   Create Controller [y/n]
   y
   ```
   This step will create both CRD
   ([api/v1/employee_types.go](api/v1/employee_types.go)) and controller
   ([controllers/employee_controller.go](controllers/employee_controller.go))
   templates for you to customize.
6. In [api/v1/employee_types.go](api/v1/employee_types.go), specify the fields
   for the Employee object's spec and status. A yaml file describing the CRD
   can be generated from this Go struct representation by running
   `make manifests`
   ```console
   demo/$ make manifests
   ```
   Once you are ready to install the CRDs, run `make install`.
7. In ([controllers/employee_controller.go](controllers/employee_controller.go)),
   add your reconcile loop logic in `EmployeeReconciler.Reconcile()`
   ```go
   func (r *EmployeeReconciler) Reconcile(ctx context.Context, req ctrl.Request) (ctrl.Result, error) {
      _ = log.FromContext(ctx)
      // TODO: Your code here.
   }

   ```
   To build the manager image, run `make build`. To deploy the manager
   in a local session, run `make run`. Otherwise, you can also build, push,
   and deploy the manager directly on the cluster by doing:
   ```console
   export IMG=<repo>/<image>[:<tag>]
   demo/$ make docker-build docker-push
   demo$/ make deploy 
   ```
8. Your CRD and controller should now be setup! Play around with the system.
   You can populate the system with some data data by doing:
   ```console
   demo/$ kubectl apply -f config/samples/cnr-na22_v1_employee.yaml
   ```